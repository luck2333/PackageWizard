# F4.9 参数提取流程说明

该文档聚焦 F4 流程的参数提取阶段（F4.9），梳理 `common_pipeline.compute_qfp_parameters` 及其依赖函数的职责与输入输出，方便后续改动。

## 总体流程
1. **整理最终配对**：`common_pipeline.finalize_pairs` 将配对过的尺寸线与 OCR 文本进行二次筛选，结合尺寸线长度、副本与原始 OCR，输出清洗后的四视图 OCR 列表以及稳定的尺寸线集合（`yolox_pairs_top/bottom/side/detailed`）。【F:package_core/PackageExtract/common_pipeline.py†L519-L574】
2. **计算核心参数**：`common_pipeline.compute_qfp_parameters` 读取上述整理结果并驱动下游函数完成 nx/ny、封装主体尺寸及其他候选参数的推断，最终返回参数列表与 nx/ny。【F:package_core/PackageExtract/common_pipeline.py†L577-L651】

## 关键函数与输入输出
### 1. `compute_qfp_parameters`
- **输入**：整理后的 OCR 数据、尺寸线长度、尺寸线副本、边框等信息。
- **步骤**：
  - 调用 `get_serial` 根据上下视图的序号标签推断引脚行列数 `nx/ny`。【F:package_core/PackageExtract/common_pipeline.py†L593-L593】【F:package_core/PackageExtract/get_pairs_data_present5_test.py†L3889-L3954】
  - 通过 `get_QFP_body` 结合尺寸线、边框与 OCR 数据推测主体长宽（`body_x/body_y`），支持缺失互补与阈值过滤。【F:package_core/PackageExtract/common_pipeline.py†L594-L604】【F:package_core/PackageExtract/get_pairs_data_present5_test.py†L4424-L4558】
  - 利用 `get_QFP_parameter_list` 基于阈值范围、主体尺寸与视图属性收集各参数的候选标注列表并计数。【F:package_core/PackageExtract/common_pipeline.py†L615-L622】【F:package_core/PackageExtract/get_pairs_data_present5_test.py†L3956-L4193】
  - 通过 `resort_parameter_list_2` 递归剔除已确定标注的重复候选，收敛候选集。【F:package_core/PackageExtract/common_pipeline.py†L623-L623】【F:package_core/PackageExtract/get_pairs_data_present5_test.py†L4195-L4230】
  - 当高度或引脚间距存在多候选时，分别调用 `get_QFP_high` 与 `get_QFP_pitch` 做二次筛选后再运行一次候选收敛。【F:package_core/PackageExtract/common_pipeline.py†L625-L649】【F:package_core/PackageExtract/get_pairs_data_present5_test.py†L1345-L1400】
- **输出**：整理后的参数候选列表与 `nx/ny`。上层会再经过 `get_BGA_parameter_data` 转成最终参数表。【F:package_core/PackageExtract/BGA_Function/f4_pipeline_runner.py†L117-L137】

### 2. `get_serial`
- **作用**：遍历上下视图的序号检测结果，统计同一方向上标注间距出现次数，选择最常见的间距估算行列数，并对缺失方向进行互补修正。【F:package_core/PackageExtract/get_pairs_data_present5_test.py†L3889-L3954】
- **输出**：估计的 `nx`（横向引脚数）与 `ny`（纵向引脚数）。

### 3. `get_QFP_body`
- **作用**：
  - 将尺寸线与引线长度合并，匹配 OpenCV 或边框检测到的主体框，筛选出最符合主体宽高的尺寸线；
  - 允许 top/bottom 以及 x/y 之间互补以填补缺失；
  - 最终把宽/高从数值向量还原成 OCR 标注字典，便于后续直接复用。
- **输入**：两视图的尺寸线、长度、边框信息以及 OCR 文本。
- **输出**：`body_x`（主体宽）与 `body_y`（主体高）的候选标注列表，若匹配失败则为空列表。【F:package_core/PackageExtract/get_pairs_data_present5_test.py†L4424-L4558】

### 4. `get_QFP_parameter_list`
- **作用**：根据不同参数的物理范围和视图来源，将可能的 OCR 标注分类到 D/E/D1/E1/A/A1/e/b/D2/E2/L/GAGE_PLANE/c/θ/θ1/θ2/θ3 等参数下，并记录候选数量。【F:package_core/PackageExtract/get_pairs_data_present5_test.py†L3956-L4193】
- **要点**：主体尺寸候选会直接填入 D1/E1 类参数，角度与高度参数通过 Absolutely 标签识别，所有参数打印调试信息以辅助核对。

### 5. `resort_parameter_list_2`
- **作用**：循环检测只有单一候选的参数，并从其他参数候选中移除同一标注，直到没有可消除的重复，从而减少歧义。【F:package_core/PackageExtract/get_pairs_data_present5_test.py†L4195-L4230】
- **输出**：更新后的候选列表，同时刷新 `maybe_data_num` 计数。

### 6. `get_QFP_high` 与 `get_QFP_pitch`
- **`get_QFP_high`**：优先选取 Absolutely 标记为 `high` 的侧视图标注；若无，则按数值最大值推断高度。【F:package_core/PackageExtract/get_pairs_data_present5_test.py†L1345-L1400】
- **`get_QFP_pitch`**：在侧视图标注中，按照 0.7×(nx-1)×pitch < body 尺寸 < pitch×(nx-1) 条件筛选出最可能的引脚间距，分别返回 x/y 方向候选。【F:package_core/PackageExtract/get_pairs_data_present5_test.py†L1345-L1361】

## 调用出口与后续
- `f4_pipeline_runner.run_f4_pipeline` 在完成 F4.8 匹配后调用上述流程，随后用 `function_tool.get_BGA_parameter_data` 将候选列表、nx、ny 转换为最终输出格式，并返回参数列表以供 UI 或后续分析使用。【F:package_core/PackageExtract/BGA_Function/f4_pipeline_runner.py†L114-L137】

