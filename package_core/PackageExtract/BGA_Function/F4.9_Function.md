# F4.9 参数提取流程说明

该文档聚焦 F4 流程的参数提取阶段（F4.9），梳理 `common_pipeline.finalize_pairs` 与 `compute_qfp_parameters` 及其依赖函数的职责、输入输出关系，方便后续改动。

## 流程概览
1. **配对收敛**：`finalize_pairs` 读取配对后的尺寸线、长度与副本，调用 `get_better_data_2` 过滤异常后写回清洗过的 OCR 数据，并生成四视图稳定的尺寸线集合 `yolox_pairs_top/bottom/side/detailed`。【F:package_core/PackageExtract/common_pipeline.py†L519-L574】
2. **参数推断**：`compute_qfp_parameters` 在上述结果基础上，估算 nx/ny、主体尺寸以及各类封装参数候选列表，最后返回参数候选与引脚行列数。【F:package_core/PackageExtract/common_pipeline.py†L577-L651】
3. **输出格式化**：`run_f4_pipeline` 随后通过 `get_BGA_parameter_data` 将候选列表与 nx/ny 转为最终参数表，供界面或下游模块使用。【F:package_core/PackageExtract/BGA_Function/f4_pipeline_runner.py†L117-L137】

## 关键函数与依赖
### 1. `finalize_pairs`
- **输入**：四视图的 OCR 结果、`*_yolox_pairs_length`（标尺端点距离）、`*_yolox_pairs_copy`（尺寸线副本）。【F:package_core/PackageExtract/common_pipeline.py†L519-L556】
- **处理**：调用 `_pairs_module.get_better_data_2` 基于尺寸线长度和副本稳定性过滤配对，并同步更新 OCR 文本列表及最终尺寸线集合。【F:package_core/PackageExtract/common_pipeline.py†L535-L566】
- **输出**：更新后的 OCR 数据与 `yolox_pairs_top/bottom/side/detailed`，为 F4.9 计算提供可靠几何信息。【F:package_core/PackageExtract/common_pipeline.py†L559-L574】

### 2. `compute_qfp_parameters`
- **输入**：
  - 序号信息（`top_serial_numbers_data`/`bottom_serial_numbers_data`）；
  - 经过 `finalize_pairs` 的 OCR 文本、尺寸线长度、副本以及边框检测结果。【F:package_core/PackageExtract/common_pipeline.py†L580-L603】
- **步骤**：
  1. `get_serial` 统计序号标签间的间距，推算引脚行列数 `nx/ny`，并进行缺失互补。【F:package_core/PackageExtract/common_pipeline.py†L593-L593】【F:package_core/PackageExtract/get_pairs_data_present5_test.py†L3889-L3954】
  2. `get_QFP_body` 综合尺寸线长度、主体边框与 OCR 文本，匹配封装主体宽高候选 `body_x/body_y`，允许 top/bottom 及 x/y 互补填充缺失。【F:package_core/PackageExtract/common_pipeline.py†L594-L604】【F:package_core/PackageExtract/get_pairs_data_present5_test.py†L4424-L4662】
  3. `get_QFP_parameter_list` 根据物理范围与 Absolutely 标记，将各视图 OCR 标注归类到 D/E/D1/E1/A/A1/e/b/D2/E2/L/GAGE_PLANE/c/θ/θ1/θ2/θ3 等参数下，并记录候选数量。【F:package_core/PackageExtract/common_pipeline.py†L615-L623】【F:package_core/PackageExtract/get_pairs_data_present5_test.py†L3956-L4193】
  4. `resort_parameter_list_2` 多轮剔除已确定标注在其他参数中的重复项，收敛候选集。【F:package_core/PackageExtract/common_pipeline.py†L623-L623】【F:package_core/PackageExtract/get_pairs_data_present5_test.py†L4195-L4230】
  5. 当高度或引脚间距存在多候选时，`get_QFP_high` 与 `get_QFP_pitch` 结合 Absolutely 标签或主体尺寸范围做二次筛选后，再次运行候选收敛。【F:package_core/PackageExtract/common_pipeline.py†L625-L649】【F:package_core/PackageExtract/get_pairs_data_present5_test.py†L1345-L1400】
- **输出**：精简后的参数候选列表以及 `nx/ny`，供 `get_BGA_parameter_data` 统一格式化。【F:package_core/PackageExtract/common_pipeline.py†L617-L651】【F:package_core/PackageExtract/BGA_Function/f4_pipeline_runner.py†L117-L137】

## 关注点（F4.9 改动建议）
- 确认 `finalize_pairs` 输入的尺寸线长度与副本来源一致，否则候选过滤会误删有效标注。
- `get_QFP_body` 将数值向量重新映射为 OCR 字典，修改时需保证数值与 `max_medium_min` 三元组一一对应。
- 调整参数筛选阈值或新增参数时，请同步更新 `get_QFP_parameter_list` 的范围判断及 `resort_parameter_list_2` 的去重逻辑，以保持候选计数准确。

## 标尺线匹配函数拆解
1. **MPD 配对**：`match_pairs_with_text` 通过 `_pairs_module.MPD` 重建 OCR-尺寸线对应关系，输出的 `matched_pairs_location` 作为后续写回和过滤的唯一凭据。【F:package_core/PackageExtract/common_pipeline.py†L474-L516】
2. **区域/引线信息写回**：`get_pairs_info` 依据尺寸线副本中的内外侧标记填充 `matched_pairs_outside_or_inside`，`get_yinxian_info` 在配对成功的前提下写入两条引线坐标和间距，未匹配的框不会被补充信息。【F:package_core/PackageExtract/get_pairs_data_present5_test.py†L2424-L2446】
3. **副本融合与筛选**：`finalize_pairs` 将长度数组与副本一起交给 `get_better_data_2`，只保留拥有有效长度/副本且配对稳定的尺寸线，并同步精简后的 OCR 数据到 `yolox_pairs_*`。【F:package_core/PackageExtract/common_pipeline.py†L519-L574】
4. **参数汇总**：`compute_qfp_parameters` 在上述筛选后的 `yolox_pairs_*` 和 OCR 列表基础上计算主体尺寸、nx/ny 以及最终参数候选，保障只在配对稳定的标注上运算。【F:package_core/PackageExtract/common_pipeline.py†L577-L651】

## Side 视图 A/A1 匹配改写思路（仅文档）
- **前置假设**：侧视图真实标注仅包含 A 与 A1，且 A 数值最大、A1 次之，额外检测框往往是噪声或其它标注。
- **拟议流程**：
  1. 在 MPD 之后，仅对 `matched_pairs_location` 非空的侧视图 OCR 框参与分配；
  2. 按 `max_medium_min` 的中值降序排序，首个设为 A；
  3. 从余下框中挑选数值最大的作为 A1，若检测框>2 则跳过最小值以降低误匹配；
  4. 若仅有一个配对成功的框，则标记为 A 并生成告警，提示需要补拍或人工核验 A1；
  5. 分配结果写入自定义字段（如 `side_a_candidate`/`side_a1_candidate`）后再进入参数筛选，避免改动现有代码路径。
